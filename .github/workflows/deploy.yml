name: Deploy Django Project (but_app)

on:
  push:
    branches:
      - shalghampaz

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@v1.0.0
with:
  host: ${{ secrets.SERVER_IP }}
  username: ${{ secrets.SERVER_USER }}
  key: ${{ secrets.SSH_PRIVATE_KEY }}
  port: 522
  script: |
    cd /home/ubntkhub/

    echo "‚úÖ Backup old project..."
    if [ -d "but_app" ]; then
      tar -czf but_app_backup_$(date +%F_%T).tar.gz but_app
      rm -rf but_app
    fi

    echo "‚¨áÔ∏è Clone new version from GitHub..."
    git clone -b shalghampaz git@github.com:<YOUR_USERNAME>/<YOUR_REPO>.git but_app

    echo "üì¶ Activate virtualenv and migrate..."
    cd but_app
    source venv/bin/activate
    python manage.py migrate
    python manage.py collectstatic --noinput

    echo "üîÑ Restart Apache..."
    sudo systemctl restart apache2

